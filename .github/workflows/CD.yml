name: CD using Docker Image

on:
    push:
        tags:
            - "*.*.*"

env:
    IMAGE: ${{ vars.NCR_HOST }}/lion-app
    IMAGE_TAG: ${{ vars.NCR_HOST }}/lion-app:latest
    CONTAINER_NAME: lion-app-dc

jobs:
    deploy:
        name: deploy the new version
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Helm repository
              uses: actions/checkout@v3
              with:
                repository: 25th-Night/lion-k8s
                ref: main
                token: ${{ secrets.PAT }}
            - name: Get version
              if: startsWith(github.ref, 'refs/tags')
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
            - name: Update Chart.yaml
              run: |
                sed -i "s/appVersion.*/appVersion: ${{ steps.version.outputs.VERSION }}/g" lionp/Chart.yaml
                cat lionp/Chart.yaml
              shell: bash
            - name: Commit and Push to Repository
              uses: stefanzweifel/git-auto-commit-action@v4
              with:
                commit_message: Update Version to ${{ steps.version.outputs.VERSION }}
                branch : main